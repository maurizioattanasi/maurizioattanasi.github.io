---
layout: post
title: Integrazione Continua su Azure con git e azure-cli
date: '2016-11-28T23:03:00.001+01:00'
author: Maurizio Attanasi
tags:
- ".NET"
- Azure
- git
- node.js
- Angular 2
- Cloud
modified_time: '2016-11-28T23:39:56.289+01:00'
blogger_id: tag:blogger.com,1999:blog-2699321970282050013.post-5637943563109106582
blogger_orig_url: https://maurizioattanasi.blogspot.com/2016/11/integrazione-continua-su-azure-con-git_28.html
---

In un precedente post (<a href="https://maurizioattanasi.blogspot.it/2016/09/integrazione-continua-con-visual-studio.html">Integrazione Continua con Visual Studio Team Service</a>) avevo condiviso il link ad un tutorial che illustrava il servizio di <em>Continuous Integration</em> offerto da <a href="https://www.visualstudio.com/team-services/">Visual Studio Team Services</a>. In questa nota riporterò gli step necessari ad ottenere un risultato analogo <br />per la pubblicazione su una Web Application su <a href="https://azure.microsoft.com/it-it/">Azure</a> sfruttando <a href="https://git-scm.com/">git</a> come sistema di versioning, e <a href="https://docs.microsoft.com/it-it/azure/xplat-cli-install">azure-cli</a>, un’interfaccia della riga di comando di Azure. <br />Gli strumenti necessari per raggiungere il nostro fine sono:<br /><ul><li>node.js (del quale utilizzeremo il gestore dei pacchetti, <em>npm</em>, per l’installazione, tra l’altro, di <em>angular-cli</em>);</li><li>git;</li><li>azure-cli;</li><li>un account Azure valido (anche un free trial);</li></ul>Data la natura degli strumenti sopra elencati, la procedura che andremo a descrivere vale per tutti i sistemi operativi per i quali tali strumenti sono disponibili, e quindi Windows, Linux e osX/macOS. <br />In primo luogo verifichiamo che sul sistema sia installato <a href="https://nodejs.org/it/">Node.js</a> eseguendo su una shell di comando<br /><pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">bash</span><span class="hljs-literal">-</span><span class="hljs-comment">3</span><span class="hljs-string">.</span><span class="hljs-comment">2$</span> <span class="hljs-comment">node</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">version</span><br /><span class="hljs-comment">v7</span><span class="hljs-string">.</span><span class="hljs-comment">2</span><span class="hljs-string">.</span><span class="hljs-comment">0</span></code></pre>Nel caso in cui <strong>Node.js</strong> non sia presente sul sistema procederemo alla sua installazione seguendo le istruzioni presenti sul sito. <br />Allo stesso modo verifichiamo la presenza sul nostro sistema di <strong>git</strong><br /><pre class="prettyprint"><code class=" hljs livecodeserver">bash-<span class="hljs-number">3.2</span>$ git <span class="hljs-comment">--version</span><br />git <span class="hljs-built_in">version</span> <span class="hljs-number">2.9</span><span class="hljs-number">.3</span> (Apple Git-<span class="hljs-number">75</span>)</code></pre>e <strong>azure-cli</strong><br /><pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">bash</span><span class="hljs-literal">-</span><span class="hljs-comment">3</span><span class="hljs-string">.</span><span class="hljs-comment">2$</span> <span class="hljs-comment">azure</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">version</span><br /><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">10</span><span class="hljs-string">.</span><span class="hljs-comment">7</span> <span class="hljs-comment">(node:</span> <span class="hljs-comment">7</span><span class="hljs-string">.</span><span class="hljs-comment">2</span><span class="hljs-string">.</span><span class="hljs-comment">0)</span></code></pre>Nel caso in cui questo pacchetto non sia presente sul sistema, utilizzeremo <strong>npm</strong> per la sua installazione<br /><pre class="prettyprint"><code class=" hljs lasso">npm install <span class="hljs-attribute">-g</span> azure<span class="hljs-attribute">-cli</span></code></pre>Preparati gli strumenti necessari, procediamo alla realizzazione di una <strong>Web Application</strong> ed alla sua pubblicazione su <strong>Azure</strong>.<br /><ol><li><strong>Login</strong> <br />Per eseguire il login dalla linea di comando di azure, eseguiamo:</li></ol><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>azure login</code></pre>e seguiamo le istruzioni riportate nella risposta <br /><img alt="azure login" height="143" src="https://drive.google.com/uc?id=0BzugrVNPI3_rUXpRQmtJc25QSzA" title="" width="400" /> <br />2. <strong>Impostazione Gestione servizi di Azure (asm)</strong> <br />Per abilitare i comandi della modalità Service Management dell’interfaccia della riga di comando di Azure, eseguire il comando.<br /><pre class="prettyprint"><code class=" hljs ruby">bash-<span class="hljs-number">3.2</span><span class="hljs-variable">$ </span>azure config mode asm</code></pre><ol><li><strong>Impostazione dell’utente per la pubblicazione</strong> <br />Per impostare nome utente e password per la pubblicazione della <strong>Web Application</strong>, eseguire il comando:</li></ol><pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">azure</span> <span class="hljs-comment">site</span> <span class="hljs-comment">deployment</span> <span class="hljs-comment">user</span> <span class="hljs-comment">set</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">username</span> &lt;<span class="hljs-comment">username</span>&gt; <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">pass</span> &lt;<span class="hljs-comment">password</span>&gt;</code></pre><h2 id="creazione-della-web-application">Creazione della Web Application</h2>Tra le varie possibilità disponibili, (html, asp.net, Node.js, …), realizzeremo una Web Application faremo con l’ultima nata delle tecnologie ASP.NET:  <br /><a href="https://www.microsoft.com/net/">ASP.NET Core</a>. <br />Verifichiamo la presenza dell’sdk sul nostro sistema con il comando<br /><pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-title">bash</span>-<span class="hljs-number">3.2</span>$ <span class="hljs-keyword">dotnet</span> <span class="hljs-comment">--version</span><br /><span class="hljs-number">1.0</span><span class="hljs-number">.0</span>-preview2-<span class="hljs-number">1</span>-<span class="hljs-number">003177</span></code></pre>Nel caso in cui .net non sia presente, seguiamo le <a href="https://www.microsoft.com/net/core#macos">istruzioni</a> <br />relative al sistema operativo di nostro interesse.<br /><h2 id="yeoman">Yeoman</h2>Per semplificare l’implementazione della web app utilizzeremo <a href="http://yeoman.io/">Yeoman</a>, il set di strumenti per la creazione di progetti web già visto in un precedente <a href="https://maurizioattanasi.blogspot.it/2016/09/internet-of-things-mean-stack-part-ii.html">post</a>. <br />In primo luogo procederemo all’installazione del <em>generator</em> necessario alla realizzazione di un progetto <strong>.net Core</strong> con il comando<br /><pre class="prettyprint"><code class=" hljs lasso">$ sudo npm install <span class="hljs-attribute">-g</span> generator<span class="hljs-attribute">-aspnet</span></code></pre>Procediamo quindi alla creazione del nostro progetto creando la seguente gerarchia di directories:<br /><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>mkdir <span class="hljs-constant">CloudWorkbenchWebApplication</span><br /><span class="hljs-variable">$ </span>mkdir <span class="hljs-constant">CloudWorkbenchWebApplication</span>/src<br /><span class="hljs-variable">$ </span>mkdir <span class="hljs-constant">CloudWorkbenchWebApplication</span>/test<br /><span class="hljs-variable">$ </span>cd <span class="hljs-constant">CloudWorkbenchWebApplication</span>/</code></pre>Nella cartella root del nostro progetto, creiamo il file <em>global.json</em> <br />che conterrà il seguente oggetto <em>json</em><br /><pre class="prettyprint"><code class=" hljs json">{<br />  "<span class="hljs-attribute">projects</span>": <span class="hljs-value">[ <span class="hljs-string">"src"</span>, <span class="hljs-string">"test"</span> ]</span>,<br />  "<span class="hljs-attribute">sdk</span>": <span class="hljs-value">{<br />    "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0-preview2-1-003177"</span><br />  </span>}<br /></span>}</code></pre>Spostandoci nella cartella <em>src</em>, eseguiamo il comando <br /><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>yo aspnet</code></pre>in risposta al quale verrà avviata una procedura guidata per la creazione del nostro progetto <br /><img alt="yo aspnet" height="273" src="https://drive.google.com/uc?id=0BzugrVNPI3_rMW52clVyNVU1UjA" title="" width="400" /> <br />Selezionando la voce <strong>Empty Web Application</strong>, e, in seguito assegnando il nome <strong>CloudWorkbenchWebApplication</strong>, <br />verrà creata l’infrastruttura di una semplice Web Application <strong>ASP.NET Core</strong>. <br />Spostandoci nella cartella appena creata (<em>CloudWorkbenchWebApplication</em>), eseguiamo in sequenza i comandi<br /><pre class="prettyprint"><code class=" hljs applescript">dotnet restore<br />dotnet <span class="hljs-command">run</span></code></pre><img alt="dotnet run" height="273" src="https://drive.google.com/uc?id=0BzugrVNPI3_rc2k0d2F1ZmVmams" title="" width="400" /> <br />In questo modo abbiamo avviato, sulla nostra macchina un Web Server che risponderà all’indirizzo riportato (nel nostro caso <a href="http://localhost:5000/">http://localhost:5000/</a>). <br />Avviando un browser e puntando all’indirizzo di cui sopra avremo: <br /><img alt="Local Run" height="248" src="https://drive.google.com/uc?id=0BzugrVNPI3_rV0s0ZUZyZkhQaDA" title="" width="400" /><br />Et voilà, abbiamo la nostra Web Application!<br /><h2 id="creazione-del-repository-git">Creazione del repository git</h2>Tornando nella directory root del nostro progetto (quella contenente la cartelle src e test ed il file global.json), <br />1. <strong>creiamo il repository git</strong><br /><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>git init</code></pre><ol><li><strong>aggiungiamo tutti i files e le cartelle create</strong></li></ol><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>git add .</code></pre><ol><li><strong>eseguiamo il primo commit</strong></li></ol><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>git commit -m <span class="hljs-string">"Initial commit"</span></code></pre><h2 id="creazione-della-web-application-su-azure">Creazione della Web Application su Azure</h2>Mediante la linea di comando di azure, creiamo la nostra web application<br /><pre class="prettyprint"><code class=" hljs brainfuck"> <span class="hljs-comment">azure</span> <span class="hljs-comment">site</span> <span class="hljs-comment">create</span> &lt;<span class="hljs-comment">app_name</span>&gt; <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">git</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">gitusername</span> &lt;<span class="hljs-comment">username</span>&gt;</code></pre>dove <em>app_name</em> è il nome che assegneremo alla web application, e <em>username</em> è il nome utente impostato nel passaggio precedente.<br /><img alt="site creation" height="273" src="https://drive.google.com/uc?id=0BzugrVNPI3_rR1V4S2lkMThKS3c" title="" width="400" /> <br />Selezioniamo il server sul quale pubblicheremo la nostra applicazione (nel nostro caso 3. West Europe). <br />Al termine dell’operazione, accedendo al portale di Azure, avremo, tra le risorse disponibili, quella appena creata<br /><img alt="azure portal" height="270" src="https://drive.google.com/uc?id=0BzugrVNPI3_rU2MxRThZWXhCazg" title="" width="400" /> <br />Visualizzando i dettagli della nostra App, abbiamo <br /><img alt="azure site detail" height="305" src="https://drive.google.com/uc?id=0BzugrVNPI3_rODBpQ0UyUnNSSzQ" title="" width="400" /> <br />e, selezionando il pulsante <em>Browse</em> siamo in grado di visualizzare la web app appena creata (anche se vuota).<br /><img alt="site-browse" height="305" src="https://drive.google.com/uc?id=0BzugrVNPI3_reFlXVWdYMGNxWDQ" title="" width="400" /><br /><h2 id="pubblicazione-della-web-application">Pubblicazione della web application</h2>Siamo pronti per eseguire il primo <em>push</em> verso il repository <em>azure</em> creato in precedenza. <br />A tal fine eseguiamo il comando<br /><pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>git push azure master</code></pre>Oltre che copiare i file dal nostro repository locale al site di azure, il processo avvierà le operazioni di <em>restore</em> e <em>build</em> dell’applicazione, ed infine alla pubblicazione dell’app. <br />Se l’operazione è andata a buon fine, ricaricando il browser all’indirizzo precedente, abbiamo: <br /><img alt="published-site" height="305" src="https://drive.google.com/uc?id=0BzugrVNPI3_rbVh3N3RibC0tcHc" title="" width="400" /> <br />Et voilà ancora!!! Abbiamo ottenuto il risultato voluto, ovvero siamo riusciti a pubblicare la nostra web application raggiungibile all'indirizzo <a href="http://cloud-workbench.azurewebsites.net/" target="_blank">http://cloud-workbench.azurewebsites.net/</a>&nbsp;utilizzando git e la linea di comando di azure.<br /><h2 id="configurazione-versione-di-nodejs">Configurazione versione di Node.js</h2>Poiché la web application che abbiamo appena creato sarà il punto di partenza per una serie prove per verificare le potenzialità di Azure per le applicazioni IoT, per provare Angular 2 in combinazione con .net core, ed altro ancora, facciamo un ulteriore passaggio per aggiornare la versione di Node.js di della nostra app azure con quella installata sul nostro sistema di sviluppo (la 7.2.0, come abbiamo visto all’inizio del post). <br />Tra gli <em>Application Settings</em> della nostra Web App individuiamo la chiave <strong>WEBSITE_NODE_DEFAULT_VERSION</strong> e modifichiamone il valore a <strong>7.2.0</strong>, come illustrato nell’immagine seguente. <br /><img alt="application-settings" height="294" src="https://drive.google.com/uc?id=0BzugrVNPI3_rZjByZlYxTkRndTg" title="" width="400" />. <br />Salvando le modifiche effettuate il sito verrà riavviato e, se non ci sono problemi, ricaricando la pagina otterremo ancora il nostro <strong>Hello World</strong>.<br /><br />Enjoy<br /><br /><div style="text-align: left;"><div style="display: inline-block;"><script data-counter="right" data-url="https://maurizioattanasi.blogspot.it/2016/11/integrazione-continua-su-azure-con-git_28.html" type="IN/Share"></script><br /></div><div class="g-plusone" data-annotation="inline" data-width="300" style="display: inline-block;"></div></div>