---
layout: post
title: Utilizzo di una dll .NET da codice 'nativo' (parte 2)
date: '2014-11-29T20:40:00.001+01:00'
author: Maurizio Attanasi
tags:
- ".NET"
- Ambienti di sviluppo
- Win32
modified_time: '2015-08-14T22:48:45.844+02:00'
blogger_id: tag:blogger.com,1999:blog-2699321970282050013.post-1025716536767362598
blogger_orig_url: https://maurizioattanasi.blogspot.com/2014/11/utilizzo-di-una-dll-net-da-codice_29.html
---

Nel post precedente, abbiamo visto come realizzare una <em>dll</em> con tecnologia <strong>.NET</strong>, in grado di consentire ad una qualunque applicazione (sviluppata con tecnologia <strong>.NET</strong>) di usufruire di un generico servizio web. Tuttavia il problema di partenza era quello di creare un ponte tra il framework .NET ed un’applicazione <em>Win 32</em>.<br /><h1 id="il-wrapper-ccli">Il wrapper C++/CLI</h1>Passiamo quindi a descrivere i passi per lo sviluppo del nostro <em>wrapper</em>, ovvero della <em>dll</em> che renderà accessibili i servizi esportati dalla libreria dinamica implementata negli step precedenti.  <br />● Il primo passo è quello di creare un progetto C++ per la creazione di una dll, ed abilitare il <em>Supporto Common Language Runtime (/clr)</em>.<br /><img align="middle" height="320" src="https://drive.google.com/uc?export=view&amp;id=0BzugrVNPI3_rQVN5OXdRdElIb28" width="480" /><br />● Aggiungiamo un riferimento alla <em>dll</em> prodotta dal progetto <strong>GoogleMapsAPI</strong><br /><img height="320" src="https://drive.google.com/uc?export=view&amp;id=0BzugrVNPI3_rR2RncFJ1WjRJQzg" width="480" /><br />● Fatto ciò aggiungeremo due classi <em>CGoogleMapsClientIntefacePrivate</em> e <em>CGoogleMapsClientInteface</em>.<br /><pre class="prettyprint"><code class="language-csharp hljs cs"><span class="hljs-preprocessor">#<span class="hljs-keyword">pragma</span> once</span><br /><br /><span class="hljs-preprocessor"># include &lt;string&gt;</span><br /><br /><span class="hljs-keyword">using</span> namespace std;<br /><br />class CGoogleMapsClientIntefacePrivate;<br /><br />class CGoogleMapsClientInteface<br />{<br /><span class="hljs-keyword">public</span>:<br />    <span class="hljs-title">CGoogleMapsClientInteface</span>();<br />    ~CGoogleMapsClientInteface();<br /><br /><span class="hljs-preprocessor">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">region</span> Attributes</span><br /><span class="hljs-keyword">private</span>:<br /><br />    CGoogleMapsClientIntefacePrivate* _private;<br /><br /><span class="hljs-preprocessor">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">endregion</span></span><br /><br /><span class="hljs-preprocessor">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">region</span> Properties</span><br /><span class="hljs-keyword">public</span>:<br />    __<span class="hljs-title">declspec</span>(<span class="hljs-title">property</span>(<span class="hljs-keyword">get</span> = GetLatitude)) <span class="hljs-keyword">double</span> Latitude;<br />    <span class="hljs-keyword">double</span> GetLatitude(<span class="hljs-keyword">void</span>);<br /><br />    __declspec(property(<span class="hljs-keyword">get</span> = GetLongitude)) <span class="hljs-keyword">double</span> Longitude;<br />    <span class="hljs-keyword">double</span> GetLongitude(<span class="hljs-keyword">void</span>);<br /><br />    __declspec(property(put = SetAddress, <span class="hljs-keyword">get</span> = GetAddress)) <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* Address;<br />    <span class="hljs-keyword">void</span> SetAddress(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*);<br />    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* GetAddress(<span class="hljs-keyword">void</span>) <span class="hljs-keyword">const</span>;<br /><span class="hljs-preprocessor">#<span class="hljs-keyword">pragma</span> <span class="hljs-keyword">endregion</span></span><br />};</code></pre>● La cui implementazione è la seguente:<br /><pre class="prettyprint"><code class="language-csharp hljs cpp"><span class="hljs-preprocessor">#include "stdafx.h"</span><br /><span class="hljs-preprocessor">#include "GoogleMapsClientInteface.h"</span><br /><br /><span class="hljs-preprocessor"># include &lt;msclr\auto_gcroot.h&gt;</span><br /><br /><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> System::Runtime::InteropServices;<br /><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> GoogleMapsAPI;<br /><br /><span class="hljs-keyword">class</span> CGoogleMapsClientIntefacePrivate<br />{<br /><span class="hljs-keyword">public</span>:<br />    msclr::auto_gcroot&lt;GoogleMaps^&gt; googleMapsAPI;<br />};<br /><br />CGoogleMapsClientInteface::CGoogleMapsClientInteface()<br />{<br />    <span class="hljs-keyword">this</span>-&gt;_private = <span class="hljs-keyword">new</span> CGoogleMapsClientIntefacePrivate();<br />    <span class="hljs-keyword">this</span>-&gt;_private-&gt;googleMapsAPI = gcnew GoogleMaps();<br />}<br /><br /><br />CGoogleMapsClientInteface::~CGoogleMapsClientInteface()<br />{<br />    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>-&gt;_private)<br />        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>-&gt;_private;<br />}<br /><br /><span class="hljs-keyword">double</span> CGoogleMapsClientInteface::GetLatitude()<br />{<br />    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;_private-&gt;googleMapsAPI-&gt;Latitude;<br />}<br /><br /><span class="hljs-keyword">double</span> CGoogleMapsClientInteface::GetLongitude()<br />{<br />    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;_private-&gt;googleMapsAPI-&gt;Longitude;<br />}<br /><br /><span class="hljs-keyword">void</span> CGoogleMapsClientInteface::SetAddress(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* value)<br />{<br />    <span class="hljs-keyword">this</span>-&gt;_private-&gt;googleMapsAPI-&gt;Address = gcnew System::String(value);<br /><br />    <span class="hljs-keyword">this</span>-&gt;_private-&gt;googleMapsAPI-&gt;GetCoordinates();<br />}<br /><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* CGoogleMapsClientInteface::GetAddress(<span class="hljs-keyword">void</span>) <span class="hljs-keyword">const</span><br />{<br />    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*)Marshal::StringToHGlobalAnsi(<span class="hljs-keyword">this</span>-&gt;_private-&gt;googleMapsAPI-&gt;Address).ToPointer();<br /><br />}</code></pre>Il punto focale dell’implementazione è dato dalla classe <a href="http://msdn.microsoft.com/en-us/library/ms177048.aspx"><em>auto_gcroot</em></a>, che, citando l’help online di Microsoft, “può essere utilizzato per incapsulare un handle virtuale in un tipo nativo”. In altre parole questa classe ci fornirà il punto d’accesso al mondo .NET, e, ad essa delegheremo gli oneri legati alle differenti modalità di gestione della memoria tra il mondo nativo ed il mondo gestito. Tuttavia, così com’è, la classe <em>auto_gcroot</em>, parte dell’armamentario <strong>C++/CLI</strong>, non è utilizzabile in una dll <strong>C++</strong> nativa. In primo luogo perchè non verrebbe riconosciuta in fase di compilazione, ed anche perchè se venisse compilata altererebbe irrimediabilmente il livello di astrazione che stiamo cercando di dare all’intero progetto seguendo una delle tecniche care allo sviluppo C++ nativo descritte nel <a href="http://c2.com/cgi/wiki?PimplIdiom"><strong>PIMPL Idiom</strong></a>. A tale scopo abbiamo <em>nascosto</em> il nostro handle nella classe <strong>CGoogleMapsClientIntefacePrivate</strong> ottenendo un’interfaccia compatibile con il mondo nativo.<br /><h2 id="funzioni-esportate">Funzioni esportate</h2>Ottenuto il punto d’accesso, o il wrapper che dir si voglia, non ci resta che implementare la nostra <em>dll</em> nativa. Dando per scontata la parte legata allo sviluppo della dll in sé per sé, focalizzerei l’attenzione sul fatto che non abbiamo esportato direttamente la classe <strong>CGoogleMapsClientInteface</strong>, cosa del tutto lecita e possibile, ma abbiamo creato un <em>handle</em> verso essa mediante il metodo <strong>CGoogleMapsClientInteface_Create()</strong>. Il motivo di tale scelta è dato dal fatto che il nostro <em>client</em> non verrà sviluppato in C++ nativo (in tal caso ci saremmo fermati al passo precedente), ma in <strong>Delphi 7</strong>, linguaggio che ha una gestione della memoria totalmente differente da quella del C++, e che difficilmente riuscirebbe ad utilizzare una classe esportata direttamente dal nostro wrapper.<br /><pre class="prettyprint"><code class="language-csharp hljs coffeescript"><span class="hljs-comment">#ifdef CLIBRIDGE_EXPORTS</span><br /><span class="hljs-comment">#define CLIBRIDGE_API __declspec(dllexport)</span><br /><span class="hljs-comment">#else</span><br /><span class="hljs-comment">#define CLIBRIDGE_API __declspec(dllimport)</span><br /><span class="hljs-comment">#endif</span><br /><br />typedef <span class="hljs-reserved">void</span>* THandle;<br /><br /><span class="hljs-comment"># include "GoogleMapsClientInteface.h"</span><br /><br /><span class="hljs-comment">#ifdef __cplusplus</span><br />extern <span class="hljs-string">"C"</span><br />{<br /><span class="hljs-comment">#endif</span><br /><br />    inline CLIBRIDGE_API THandle CGoogleMapsClientInteface_Create()<br />    {<br />        <span class="hljs-keyword">return</span> (THandle) <span class="hljs-keyword">new</span> CGoogleMapsClientInteface();<br />    }<br /><br />    inline CLIBRIDGE_API <span class="hljs-reserved">void</span> CGoogleMapsClientInteface_SetAddress(THandle handle, <span class="hljs-reserved">const</span> char* value)<br />    {<br />        <span class="hljs-keyword">if</span> (handle)<br />        {<br />            <span class="hljs-function"><span class="hljs-params">((CGoogleMapsClientInteface*)handle)</span>-&gt;</span>Address = value;<br /><br />            <span class="hljs-function"><span class="hljs-params">((CGoogleMapsClientInteface*)handle)</span>-&gt;</span>GetAddress();<br />        }<br />    }<br />    inline CLIBRIDGE_API <span class="hljs-reserved">const</span> char* CGoogleMapsClientInteface_GetAddress(THandle handle)<br />    {<br />        <span class="hljs-keyword">return</span> (handle)<br />            ? <span class="hljs-function"><span class="hljs-params">((CGoogleMapsClientInteface*)handle)</span>-&gt;</span>Address<br />            : <span class="hljs-string">""</span>;<br />    }<br /><br />    inline CLIBRIDGE_API double CGoogleMapsClientInteface_GetLatitude(THandle handle)<br />    {<br />        <span class="hljs-keyword">return</span> (handle)<br />            ? <span class="hljs-function"><span class="hljs-params">((CGoogleMapsClientInteface*)handle)</span>-&gt;</span>Latitude<br />            : numeric_limits&lt;double&gt;::signaling_NaN();<br />    }<br /><br />    inline CLIBRIDGE_API double CGoogleMapsClientInteface_GetLongitude(THandle handle)<br />    {<br />        <span class="hljs-keyword">return</span> (handle)<br />            ? <span class="hljs-function"><span class="hljs-params">((CGoogleMapsClientInteface*)handle)</span>-&gt;</span>Longitude<br />            : numeric_limits&lt;double&gt;::signaling_NaN();<br />    }<br /><br />    CLIBRIDGE_API int fnCLIBridge(<span class="hljs-reserved">void</span>);<br /><span class="hljs-comment">#ifdef __cplusplus</span><br />}<br /><span class="hljs-comment">#endif</span></code></pre><h1 id="lapplicazione-nativa">L’applicazione nativa</h1>A questo punto non ci resta che mettere insieme i blocchi sviluppati finora per creare un programma di test scritto in  <em>idioma nativo</em>. Si tratta di una semplice applicazione <em>Console</em>, scritta in <strong>C++</strong> e non in <strong>Delphi 7</strong> (a tutto c’è un limite ;-)).<br /><pre class="prettyprint"><code class="language-csharp hljs cpp"><span class="hljs-comment">// Win32CrashTestDummy.cpp : definisce il punto di ingresso dell'applicazione console.</span><br /><span class="hljs-comment">//</span><br /><br /><span class="hljs-preprocessor">#include "stdafx.h"</span><br /><br /><span class="hljs-preprocessor"># include &lt;iostream&gt;</span><br /><span class="hljs-preprocessor"># include &lt;conio.h&gt;</span><br /><br /><span class="hljs-preprocessor"># include "CLIBridge.h"</span><br /><br /><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;<br /><br /><span class="hljs-keyword">int</span> _tmain(<span class="hljs-keyword">int</span> argc, _TCHAR* argv[])<br />{<br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ------------------------ "</span> &lt;&lt; endl;<br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ---------START---------- "</span> &lt;&lt; endl;<br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ------------------------ "</span> &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; endl;<br /><br />    <span class="hljs-comment">// cout &lt;&lt; "Exported function \'fnCLIBridge()\' returned: " &lt;&lt; fnCLIBridge() &lt;&lt; endl;</span><br /><br />    THandle handle = CGoogleMapsClientInteface_Create();<br /><br />    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* address = <span class="hljs-string">"Google Building 44, Mountain View, California, Stati Uniti"</span>;<br /><br />    CGoogleMapsClientInteface_SetAddress(handle, address);<br /><br />    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* value = CGoogleMapsClientInteface_GetAddress(handle);<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Address:\t"</span> &lt;&lt; value &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Latitude:\t"</span> &lt;&lt; CGoogleMapsClientInteface_GetLatitude(handle) &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Longitude:\t"</span> &lt;&lt; CGoogleMapsClientInteface_GetLongitude(handle) &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ------------------------ "</span> &lt;&lt; endl;<br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ----------END----------- "</span> &lt;&lt; endl;<br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ------------------------ "</span> &lt;&lt; endl;<br /><br />    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span>.get();<br />    <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">" ------------------------ "</span> &lt;&lt; endl;<br /><br />    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br />}</code></pre>Il risultato finale è illustrato nell’immagine seguente, nella quale si mette a confronto l’output dell’applicazione <em>console</em> con quella <em>WinForm</em> sviluppata nel post precedente.<br /><img height="320" src="https://drive.google.com/uc?export=view&amp;id=0BzugrVNPI3_rV0ZLVFRsU1l5bHc" width="480" /><br /><h1 id="conclusione">Conclusione</h1>Lavorando nel mondo della tecnologia, in qualsiasi ambito, l’eterogeneità degli strumenti da utilizzare è la regola e non l’eccezione, e quindi può capitare che una tecnologia <em>datata</em>, ma ancora efficiente e funzionale, debba poter accedere a nuovi strumenti. Quello illustrato è uno dei casi che ci si può trovare a dover affrontare, ed uno dei possibili metodi per risolverlo.  <br />Il link ai sorgenti dell’intero progetto raggiungibili dal link seguente <br /><a href="https://github.com/alien70/CLIWrapperDemo">Git</a><br /><strong>Enjoy</strong><br /><table><tbody><tr>         <td height="35"><img align="left" alt="Creative Commons" height="35" src="https://drive.google.com/uc?export=view&amp;id=0BzugrVNPI3_rZkM1c1F2eEE5QW8" width="100" />         </td>         <td><img align="left" alt="Quality is not for sale" height="50" src="https://drive.google.com/uc?export=view&amp;id=0BzugrVNPI3_rYk9MaWk2SGwySDg" width="100" />         </td>     </tr></tbody></table>