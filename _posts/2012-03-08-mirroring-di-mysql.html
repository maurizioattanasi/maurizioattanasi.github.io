---
layout: post
title: Mirroring di MySQL
date: '2012-03-08T21:35:00.000+01:00'
author: Maurizio Attanasi
tags:
- Database
- Programmazione
modified_time: '2012-03-13T12:09:35.663+01:00'
thumbnail: http://lh5.ggpht.com/-fnudXYv4Mt0/T1ky1x0MR8I/AAAAAAAAB5o/-6nwxascc5E/s72-c/logo-mysql-110x57_thumb%25255B8%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2699321970282050013.post-7178154890003919920
blogger_orig_url: https://maurizioattanasi.blogspot.com/2012/03/mirroring-di-mysql.html
---

<div align="justify"><a href="http://lh4.ggpht.com/-qd33KPntxUU/T1kyzOmaFSI/AAAAAAAAB5g/xnchJevy_Gg/s1600-h/logo-mysql-110x57%25255B10%25255D.png"><img align="left" alt="logo-mysql-110x57" border="0" height="76" src="http://lh5.ggpht.com/-fnudXYv4Mt0/T1ky1x0MR8I/AAAAAAAAB5o/-6nwxascc5E/logo-mysql-110x57_thumb%25255B8%25255D.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; float: left; margin: 4px 15px 0px 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="logo-mysql-110x57" width="110" /></a>Primo post del 2012 (è ovvio che non sono un blogger molto prolifico, ma la ‘mission’ del blog è quella del quaderno degli appunti ad uso più che altro personale). L’argomento del post è la configurazione di due server, un master ed uno slave, sul quale un database viene <em>replicato</em> al fine di:</div><ul><li> <div align="justify">realizzare un sistema ridondante che garantisca l’immediata disponibilità dei dati in caso di problemi tecnici sul server che ospita il master. In questo modo è possibile commutare sul server che ospita lo slave interrompendo il processo produttivo per un tempo minimo.</div></li><li> <div align="justify">ottenere un efficace sistema per il bilanciamento del carico del sistema, che consenta di eseguire le operazioni di scrittura sul master e quelle di lettura sullo slave.</div></li><li> <div align="justify">consentire backup frequenti dei dati senza inficiare le prestazioni del master.</div></li></ul><div align="justify">Ovviamente per le informazioni che seguono sono state tratte dalla documentazione ufficiale: <a href="http://dev.mysql.com/doc/refman/5.6/en/replication.html" target="_blank">http://dev.mysql.com/doc/refman/5.6/en/replication.html</a>.</div><h1>       </h1><h1>       </h1><h1 align="left">       <span style="font-size: medium;">Configurazione del master</span></h1><ol><li> <div align="left">Nel file di configurazione di MySql (my.ini o my.cnf a seconda che il database sia ospitato su server Windows o Linux), individuare il gruppo di parametri sotto la chiave [mysqld], ed aggiungere le seguenti chiavi:<br /><span style="color: orange;">server-id=1<br />log-bin=mysql-bin</span></div></li><li> <div align="left">Riavviare il server, riavviando il relativo servizio mysqld;</div></li><li> <div align="left">Creare un nuovo utente con privilegi di replica, seguendo I seguenti passi:</div><ol><li> <div align="left">Accedere ad una shell di comando mysql con il comando<br /><span style="color: orange;">mysql –u &lt;username&gt; –p&lt;password&gt;</span></div></li><li> <div align="left"><span style="color: orange;">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <a href="mailto:%E2%80%98user%E2%80%99@%E2%80%99%%E2%80%99"><span style="color: orange;">‘user’@’%’</span></a> IDENTIFIED BY ‘password’;oppure</span></div><div align="left"><span style="color: orange;">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <a href="mailto:%E2%80%98user%E2%80%99@%E2%80%99IP dello slave%E2%80%99"><span style="color: orange;">‘user’@’IP dello slave’</span></a> IDENTIFIED BY ‘password’;</span><br />Per precisione l’utente ‘user’ dovrebbe essere creato con il comando:<br /><span style="color: orange;">mysql&gt; CREATE USER <a href="mailto:%E2%80%98user%E2%80%99@%E2%80%99%%E2%80%99"><span style="color: orange;">‘user’@’%’</span></a> IDENTIFIED BY ‘password’</span><br />o</div><span style="color: orange;">mysql&gt; CREATE USER <a href="mailto:%E2%80%98user%E2%80%99@%E2%80%99%%E2%80%99"><span style="color: orange;">‘user’@’IP dello slave’</span></a> IDENTIFIED BY ‘password’</span><br />ma l’esecuzione del solo comando GRANT ha come effetto la creazione dell’utente nel caso quest’ultimo non esista.</li></ol></li><li> <div align="left">Bloccare le scritture sul server per consentirne la ‘clonazione’ sullo slave, eseguendo sulla shell di mysql il comando:<br /><span style="color: orange;">FLUSH TABLES WITH READ LOCK;</span></div></li><li> <div align="left">Copiare il database dal master allo slave copiando fisicamente I files di mysql o mediante il comando mysqldump<br /><span style="color: orange;">mysqldump –u ‘user’ –p’password’ db_instance&gt;db_instance.sql;<br />mysql&nbsp;–u ‘user’ –p’password’&nbsp; db_instance&lt; db_instance.sql;</span><br />o, in alternativa, è possibile creare un'istanza vuota del database dal prompt di mySQL<br /><span style="color: orange;">mysql&gt;CREATE DATABASE&nbsp;db_instance;</span><br />e, successivamente, eseguire il dump via rete:<br /><span style="color: orange;">mysqldump –u ‘user’ –p’password’ db_instance&nbsp;|&nbsp;mysql&nbsp;–u ‘user’ –p’password’ -h'hostname'&nbsp;db_instance</span></div></li><li> <div align="left">Sulla shell di mysql eseguire il comando <br /><span style="color: orange;">SHOW MASTER STATUS;</span><br />che ritornerà lo stato del file di log del master, ed il punto nel file in cui il master si trova prima del blocco eseguito al punto 3. Prendiamo nota di queste informazioni che serviranno nel seguito;</div></li></ol><h1>       </h1><h1>       <span style="font-size: medium;">Configurazione dello slave</span></h1><ol><li>Nel file di configurazione di mysql aggiungere alla sezione [mysqld] la chiave<br /><span style="color: orange;">server-id=2</span><br />o qualunque valore intero diverso da quello utilizzato per la configurazione del master;  </li><li>Riavviare il servizio mysqld;  </li><li>Da una shell di comando di mysql lanciata sullo slave, lanciare il comando:<br /><span style="color: orange;">CHANGE MASTER TO<br />MASTER_HOST=’X.X.X.X’,<br />MASTER_USER=’user’,<br />MASTER_PASSWORD=’password’,<br />MASTER_PORT=3306,<br />MASTER_LOG_FILE=’mysql-bin.000001’,<br />MASTER_LOG_POS=98,<br />MASTER_CONNECT_RETRY=10;</span><br />modificando il valore dei parametri in modo concorde alla configurazione del master.  </li><li>Sempre dalla shell di mysql eseguire il comando <br /><span style="color: orange;">START SLAVE;</span></li><li><div style="text-align: -webkit-left;">Sbloccare la scrittura sul master con il comando (ovviamente da un prompt di mySQL collegato al master)</div><div style="color: black; text-align: -webkit-left;"><span style="color: orange;">UNLOCK TABLES;</span></div></li></ol>Se tutto è andato a buon fine, nel file di log di mysql dello slave dovrebbe esserci qualcosa di simile:<br /><span style="color: grey;">091104 8:42:02 [Note] Slave I/O thread: connected to master ‘root@X.X.X.X:3306?, replication started in log ‘mysql-bin.000001? at position 98</span><br />Enjoy.